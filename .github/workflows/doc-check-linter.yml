name: Verify GPG-signed commits

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [ main ]
    
jobs:
  verify-signature:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for full git history

      - name: Import trusted GPG public keys
        run: |
          # Your keys + GitHub merge key
          gpg --keyserver keyserver.ubuntu.com --recv-keys \
            D432152833DA3244 \
            7F4C7CA953E1C09E \
            C97540DA6C9FA85C \
            4AEE18F83AFDEB23

      - name: Verify latest commit signature
        run: |
          echo "üîç Checking latest commit..."
          SIG=$(git log --show-signature -1)
          echo "$SIG"

          TRUSTED_KEYS="D432152833DA3244 7F4C7CA953E1C09E C97540DA6C9FA85C"
          GITHUB_KEY="4AEE18F83AFDEB23"
          TRUSTED="$TRUSTED_KEYS $GITHUB_KEY"

          if echo "$SIG" | grep -q "Good signature"; then
            for key in $TRUSTED; do
              if echo "$SIG" | grep -q "$key"; then
                echo "‚úÖ Commit signed with trusted key: $key"
                exit 0
              fi
            done
          fi

          echo "‚ùå Commit is not GPG signed with a trusted key!"
          exit 1
