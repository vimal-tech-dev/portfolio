name: Portfolio CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  # -------------------
  # 1. Lint HTML, CSS, JS
  # -------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install linters
        run: npm install -g eslint stylelint htmlhint

      - name: Lint JavaScript
        run: eslint . --ext .js,.jsx || true

      - name: Lint CSS
        run: stylelint "**/*.{css,scss}" || true

      - name: Lint HTML
        run: htmlhint "**/*.html" || true

  # -------------------
  # 2. DCO Check (Signed-off-by)
  # -------------------
  dco-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: DCO Check
        uses: tisonkun/actions-dco@v1.1

  # -------------------
  # 3. GPG Verification
  # -------------------
  gpg-check:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify GPG signatures (trusted keys + GitHub web-flow)
      run: |
        git fetch --unshallow || true

        echo "üîç Checking latest commit..."
        SIG=$(git log --show-signature -1)
        echo "$SIG"

        # Replace these with your actual key IDs from both PCs
        # Get them using: gpg --list-secret-keys --keyid-format=long
        TRUSTED_KEYS="D432152833DA3244 7F4C7CA953E1C09E C97540DA6C9FA85C"

        # GitHub's web-flow signing key (for merge commits)
        GITHUB_KEY="4AEE18F83AFDEB23"

        TRUSTED="$TRUSTED_KEYS $GITHUB_KEY"

        if echo "$SIG" | grep -q "Good signature"; then
          for key in $TRUSTED; do
            if echo "$SIG" | grep -q "$key"; then
              echo "‚úÖ Commit signed with trusted key: $key"
              exit 0
            fi
          done
        fi

        echo "‚ùå Commit is not GPG signed with a trusted key!"
        exit 1

